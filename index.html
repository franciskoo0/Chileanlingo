<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <title>Pronunciation Practice ‚Äî Fast & Friendly</title>
  <style>
    /* Mobile-first responsive UI inspired by Duolingo */
    :root{--bg:#f0f7ff;--card:#fff;--primary:#1CB0F6;--good:#58CC02;--warn:#F5A623;--bad:#FF4B4B;--muted:#666}
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#e6f5ff,#f7fbff);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#07203a;-webkit-font-smoothing:antialiased}
    /* Scale font for different screens */
    html{font-size:16px}
    @media(min-width:420px){ html{font-size:17px} }
    @media(min-width:900px){ html{font-size:18px} }

    .wrap{max-width:900px;margin:16px auto;padding:14px; padding-top: calc(env(safe-area-inset-top) + 16px)}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(16,40,60,0.08);overflow:hidden}
    h1{margin:0;font-size:1.1rem}
    .meta{color:var(--muted);font-size:.85rem;margin-top:6px}

    .question-row{display:flex;align-items:flex-start;gap:12px;margin-top:14px;flex-wrap:wrap}
    .category{font-size:.9rem;padding:6px 10px;border-radius:999px;background:rgba(28,176,246,0.12);color:var(--primary);font-weight:700}
    .qcard{flex:1;min-width:180px}
    .prompt{font-size:1.15rem;font-weight:800;opacity:0;transform:translateY(6px);animation:fadeIn .35s forwards}
    .translation{font-size:.95rem;color:var(--muted);margin-top:6px}
    .expected{color:#444;margin-top:8px;font-size:.95rem}

    /* controls - responsive stacked layout on small screens */
    .controls{display:flex;align-items:center;gap:10px;margin-top:14px;flex-wrap:wrap}
    .mic-btn{width:72px;height:72px;border-radius:50%;background:#fff;border:2px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .18s;flex:0 0 auto}
    .mic-btn:active{transform:scale(.97)}
    .mic-btn:focus{outline:3px solid rgba(28,176,246,0.18);outline-offset:4px}
    .mic-pulse{box-shadow:0 0 0 0 rgba(28,176,246,0.16);animation:micPulse 1.2s infinite}
    @keyframes micPulse{0%{box-shadow:0 0 0 0 rgba(28,176,246,0.16)}70%{box-shadow:0 0 0 22px rgba(28,176,246,0)}100%{box-shadow:0 0 0 0 rgba(28,176,246,0)}}

    .btn{padding:10px 12px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-weight:800;cursor:pointer;transition:transform .14s,background .14s;font-size:.95rem}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:#fff;border:1px solid rgba(0,0,0,0.06);color:#222}

    .wave{display:inline-flex;gap:6px;align-items:flex-end;margin-left:6px}
    .bar{width:6px;height:8px;background:rgba(0,0,0,0.08);border-radius:3px;transition:height .12s;background:linear-gradient(180deg,#1CB0F6,#58CC02)}

    .progress{height:10px;background:#eef6fb;border-radius:999px;margin-top:18px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),#16a085);width:0%;transition:width .45s ease}

    /* feedback card */
    .result{margin-top:14px;padding:12px;border-radius:10px;background:#fbfffb;transform:translateY(12px);opacity:0;transition:all .28s}
    .result.show{opacity:1;transform:translateY(0)}
    .result.good{background:rgba(88,204,2,0.06);border:1px solid rgba(88,204,2,0.12);color:var(--good)}
    .result.warn{background:rgba(245,166,35,0.06);border:1px solid rgba(245,166,35,0.12);color:var(--warn)}
    .result.bad{background:rgba(255,75,75,0.04);border:1px solid rgba(255,75,75,0.08);color:var(--bad)}

    .stars{font-size:1.05rem}
    details{margin-top:8px}

    /* subtle confetti */
    .confetti-piece{position:absolute;width:8px;height:8px;border-radius:2px;opacity:0;pointer-events:none}
    @keyframes confettiDrop{0%{transform:translateY(-10px) rotate(0);opacity:1}100%{transform:translateY(120px) rotate(360deg);opacity:0}}

    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

    .small{font-size:.88rem;color:var(--muted)}

    /* Desktop layout */
    @media(min-width:700px){ .wrap{padding:20px} .mic-btn{width:64px;height:64px} }

    /* Mobile optimizations */
    @media(max-width:520px){
      .wrap{margin:8px;padding:12px}
      .controls{align-items:center}
      .live { width:100% }
      .mic-btn{width:82px;height:82px}
      .qcard{min-width:0}
      .prompt{font-size:1.05rem}
      .liveTranscript{min-width:unset;max-width:100%;margin-left:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <h1>Pronunciation Practice</h1>
      <div class="meta">A1‚ÄìA2 level ‚Äî quick and friendly. Answer in English.</div>

      <div class="question-row">
        <div class="category" id="category">üè† Personal Info</div>
        <div class="qcard">
          <div class="prompt" id="prompt">Welcome</div>
          <div class="translation small" id="translation">Press Next to start</div>
          <div class="expected small" id="expected">Expected: ‚Äî</div>
        </div>
      </div>

      <div class="controls">
        <button id="micBtn" class="mic-btn" title="Record" aria-label="Record your answer" aria-pressed="false">
          <svg id="micIcon" width="28" height="28" viewBox="0 0 24 24" fill="#1CB0F6" aria-hidden="true"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/><path d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 0 0-2 0 7 7 0 0 0 6 6.92V22h-3a1 1 0 0 0 0 2h8a1 1 0 0 0 0-2h-3v-4.08A7 7 0 0 0 19 11z"/></svg>
        </button>
        <button id="startBtn" class="btn">Start</button>
        <button id="stopBtn" class="btn ghost" disabled>Stop</button>
        <button id="playSampleBtn" class="btn ghost" title="Play sample">Play sample</button>
        <button id="nextMainBtn" class="btn ghost" style="margin-left:6px">Next</button>
        <div class="wave" id="wave"><div class="bar" style="height:6px"></div><div class="bar" style="height:10px"></div><div class="bar" style="height:8px"></div></div>
        <div id="liveTranscript" class="small liveTranscript" role="status" aria-live="polite" style="margin-left:12px;margin-top:8px;padding:8px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.04);min-width:220px;min-height:36px;max-width:320px;overflow:auto">Say something...</div>
        <div style="margin-left:auto;text-align:right">
          <div class="small">Question <span id="qnum">0</span>/15</div>
          <div class="small" id="timer">00:00</div>
        </div>
      </div>

      <div class="progress"><i id="progressBar"></i></div>

      <div class="result" id="resultCard" aria-live="polite">
        <div id="resultText">‚Äî</div>
          <div class="stars" id="stars"> </div>
        <div class="small" id="recognized">Recognized: ‚Äî</div>
        <div id="issuesList" style="margin-top:8px"></div>
        <details><summary>Pronunciation tips</summary><div id="tips">‚Äî</div></details>
        <div id="progressSummary" class="small" style="margin-top:8px;color:#333"></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="tryBtn" class="btn ghost">Try Again</button><button id="nextBtn" class="btn">Next Question</button></div>
      </div>

      <div class="small" style="margin-top:12px">Progress and gentle encouragement: ‚úÖ ‚úÖ Keep going! üéØ</div>
    </div>
  </div>

  <script>
// Lightweight interactive app with CSS-driven animations and minimal JS
const questions = [
  {cat:'Personal Info üè†', q:'What is your name?', t:'¬øCu√°l es tu nombre?', hint:'My name is ... / I am ...'},
  {cat:'Personal Info üè†', q:'How old are you?', t:'¬øCu√°ntos a√±os tienes?', hint:'I am ... years old'},
  {cat:'Personal Info üè†', q:'Where are you from?', t:'¬øDe d√≥nde eres?', hint:'I am from ...'},
  {cat:'Personal Info üè†', q:'What is your nationality?', t:'¬øCu√°l es tu nacionalidad?', hint:'I am ...'},
  {cat:'Personal Info üè†', q:'Are you a student?', t:'¬øEres estudiante?', hint:'Yes, I am a student / No, I am not'},
  {cat:'Daily Routine ‚è∞', q:'What time do you wake up?', t:'¬øA qu√© hora te levantas?', hint:'I wake up at ...'},
  {cat:'Daily Routine ‚è∞', q:'Do you have breakfast every day?', t:'¬øDesayunas todos los d√≠as?', hint:'Yes, I have breakfast / No, I don\'t'},
  {cat:'Daily Routine ‚è∞', q:'How do you go to university?', t:'¬øC√≥mo vas a la universidad?', hint:'I go by bus / I walk'},
  {cat:'Daily Routine ‚è∞', q:'What time do you start classes?', t:'¬øA qu√© hora empiezan tus clases?', hint:'I start classes at ...'},
  {cat:'Daily Routine ‚è∞', q:'Do you study in the evening?', t:'¬øEstudias por la noche?', hint:'Yes, I study in the evening / No, I don\'t'},
  {cat:'Free Time üéÆ', q:'What do you do in your free time?', t:'¬øQu√© haces en tu tiempo libre?', hint:'I ... (read, play, watch)'},
  {cat:'Free Time üéÆ', q:'Do you play any sports?', t:'¬øPracticas alg√∫n deporte?', hint:'Yes, I play ... / No, I don\'t'},
  {cat:'Free Time üéÆ', q:'What music do you listen to?', t:'¬øQu√© m√∫sica escuchas?', hint:'I listen to ...'},
  {cat:'Free Time üéÆ', q:'Do you watch movies or series?', t:'¬øVes pel√≠culas o series?', hint:'Yes, I watch ... / No, I don\'t'},
  {cat:'Free Time üéÆ', q:'How often do you go out with friends?', t:'¬øCon qu√© frecuencia sales con amigos?', hint:'I go out ... (once a week)'}
];

// Example answers aligned with each question (used for TTS sample)
const samples = [
  'My name is Mar√≠a.',
  'I am 21 years old.',
  'I am from Spain.',
  'I am Spanish.',
  'Yes, I am a student.',
  'I wake up at 7:00.',
  'Yes, I have breakfast every day.',
  'I go by bus.',
  'I start classes at 9:00.',
  'Yes, I study in the evening.',
  'I read and play games in my free time.',
  'Yes, I play football.',
  'I listen to pop music.',
  'Yes, I watch series.',
  'I go out with friends once a week.'
];

function sampleForQuestion(i){ if(typeof i !== 'number' || i<0 || i>=samples.length) return ''; return samples[i]; }

// Pronunciation error database (word -> common mistaken forms + feedback)
const pronunciationErrors = {
  "think": { errors:["tink","sink","fink"], feedback:"The 'TH' sound: Put your tongue between your teeth and blow air. Don't say 'T' or 'S'.", spanish:"Coloca tu lengua entre los dientes, no digas 'tink' sino 'zink' suave" },
  "this": { errors:["dis","zis"], feedback:"The 'TH' in 'this' is voiced - your tongue vibrates between teeth.", spanish:"La lengua entre los dientes pero vibra, no es 'D'" },
  "three": { errors:["tree","free"], feedback:"Start with tongue between teeth for 'TH', then 'ree'", spanish:"Empieza con lengua entre dientes: 'z-rii' no 'trii'" },
  "very": { errors:["berry","bery"], feedback:"Use your upper teeth on lower lip for 'V' sound. It's different from 'B'!", spanish:"Dientes arriba tocan labio abajo para 'V'. No es como 'B'" },
  "have": { errors:["jav","hab","haf","av"], feedback:"Pronounce the 'H' softly, and 'V' with teeth on lip.", spanish:"La 'H' suena (no es muda), y 'V' con dientes en labio" },
  "hello": { errors:["ello","jello"], feedback:"The 'H' is pronounced - breathe out gently, softer than Spanish 'J'", spanish:"La 'H' se pronuncia - como 'J' espa√±ola pero mucho m√°s suave" },
  "how": { errors:["ow","jow"], feedback:"Start with a soft 'H' breath sound", spanish:"Empieza con 'H' aspirada suave, no la omitas" },
  "name": { errors:["nem","naim"], feedback:"The 'A' sounds like 'ei' in Spanish - say 'n√©im'", spanish:"La 'A' suena como 'ei': 'n√©im' no 'nem'" },
  "am": { errors:["em"], feedback:"'AM' sounds like '√¶m' - open mouth wider than 'e'", spanish:"Abre m√°s la boca, entre 'a' y 'e' espa√±ola" },
  "wake": { errors:["wei","guei"], feedback:"Don't drop the final 'K' sound - 'weik' not 'wei'", spanish:"No omitas la 'K' final - pron√∫nciala claramente" },
  "old": { errors:["ol"], feedback:"Pronounce the final 'D' clearly", spanish:"La 'D' final debe escucharse" }
};

// Tracking common errors across session
const errorCounts = {}; let answeredCount = 0;

// Utility: normalize string (lowercase, remove punctuation except apostrophes)
function normalizeText(s){ return (s||'').toLowerCase().replace(/[\u2019\u2018]/g, "'").replace(/[^a-z0-9\s']/g,'').replace(/\s+/g,' ').trim(); }

// Levenshtein and similarity (already present) kept for fuzzy checks

let idx = -1; const total = questions.length;
const categoryEl = document.getElementById('category');
const promptEl = document.getElementById('prompt');
const translationEl = document.getElementById('translation');
const expectedEl = document.getElementById('expected');
const qnumEl = document.getElementById('qnum');
const progressBar = document.getElementById('progressBar');
const micBtn = document.getElementById('micBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const waveBars = document.querySelectorAll('.bar');
const timerEl = document.getElementById('timer');
const resultCard = document.getElementById('resultCard');
const resultText = document.getElementById('resultText');
const starsEl = document.getElementById('stars');
const tipsEl = document.getElementById('tips');
const tryBtn = document.getElementById('tryBtn');
const nextBtn = document.getElementById('nextBtn');
const nextMainBtn = document.getElementById('nextMainBtn');
const playSampleBtn = document.getElementById('playSampleBtn');

let recognition = null; let recordingTimer = null; let seconds = 0;
if(window.webkitSpeechRecognition){ recognition = new webkitSpeechRecognition(); }
else if(window.SpeechRecognition){ recognition = new SpeechRecognition(); }
if(recognition){ recognition.lang = 'en-US'; recognition.continuous = false; recognition.interimResults = true; recognition.maxAlternatives = 1; }
else { // show clear message and disable start
  startBtn.disabled = true; timerEl.textContent = 'SpeechRecognition not available. Use Chrome/Edge and serve via HTTPS.';
}

function showQuestion(i){
  if(i<0){ promptEl.textContent='Welcome'; translationEl.textContent='Press Next to start'; expectedEl.textContent='Expected: ‚Äî'; categoryEl.textContent='üè† Personal Info'; qnumEl.textContent='0'; progressBar.style.width='0%'; resultCard.classList.remove('show'); return; }
  const q = questions[i]; categoryEl.textContent = q.cat; promptEl.textContent = q.q; translationEl.textContent = q.t; expectedEl.textContent = 'Expected: ' + q.hint; qnumEl.textContent = (i+1) + '/' + total; const pct = Math.round(((i+1)/total)*100); progressBar.style.width = pct + '%'; resultCard.classList.remove('show');
}

function startTimer(){ seconds=0; timerEl.textContent='00:00'; recordingTimer = setInterval(()=>{ seconds++; const m = String(Math.floor(seconds/60)).padStart(2,'0'); const s = String(seconds%60).padStart(2,'0'); timerEl.textContent = `${m}:${s}`; // animate wave
  waveBars.forEach((b,i)=>{ b.style.height = (6 + Math.abs(Math.sin((seconds+ i)/1.2))*18) + 'px'; }); },300); }
function stopTimer(){ clearInterval(recordingTimer); recordingTimer=null; timerEl.textContent='00:00'; waveBars.forEach(b=>b.style.height='8px'); }

// minimal confetti: create a few small pieces
function confetti(){ const colors=['#58CC02','#1CB0F6','#FF4B4B','#F5A623']; for(let i=0;i<10;i++){ const el = document.createElement('div'); el.className='confetti-piece'; el.style.left = (50 + (Math.random()*60-30)) + '%'; el.style.top = '10%'; el.style.background = colors[Math.floor(Math.random()*colors.length)]; el.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`; el.style.animation = `confettiDrop ${0.9 + Math.random()*0.6}s linear forwards`; el.style.opacity = '1'; document.getElementById('app').appendChild(el); setTimeout(()=>el.remove(),1600); } }

// Smart analyze pronunciation comparing expected phrase and heard phrase
function analyzePronunciation(expected, heard, confidence=null){
  // Support multiple acceptable variants separated by '/'
  const rawVariants = (expected||'').split('/').map(s=>s.trim()).filter(Boolean);
  const variants = rawVariants.length? rawVariants : [expected];
  const normHeard = normalizeText(heard);
  if(!normHeard){ return {score:0, errors:[{word:null,mistake:null,feedback:'No speech detected',spanish:'No se detect√≥ audio'}], heard:heard}; }

  let bestResult = { score: -1, errors:[], feedback:[], heard: heard };

  // helper to analyze one variant string
  function analyzeOne(variant){
    const normExpected = normalizeText(variant);
    const expectedWords = (normExpected||'').split(' ').filter(Boolean);
    const rawHeardWords = (normHeard||'').split(' ').filter(Boolean);
    let score = 100; const errors = [];

    // Accept some common contractions/variations mapping and expand heard tokens
    const variantsMap = { "i'm":"i am", "im":"i am", "i m":"i am", "dont":"do not", "doesnt":"does not" };
    const heardExpanded = rawHeardWords.map(w=> variantsMap[w] ? variantsMap[w] : w ).join(' ');
    const heardTokens = heardExpanded.split(' ').filter(Boolean);

    // quick equivalence checks (e.g. "my name is X" ~= "i am X")
    function checkEquivalence(expectedWordsArr, heardTokensArr){
      const ev = expectedWordsArr.join(' ');
      // My name is X  <-> I am X  or I'm X or im X
      if(ev.startsWith('my name is')){
        if((heardTokensArr.includes('i') && heardTokensArr.includes('am')) || heardTokensArr.some(h=> h.includes("i'm") || h==='im')){ return true; }
      }
      if(ev.startsWith('i am') || ev.startsWith("i'm")){
        if(heardTokensArr.includes('my') && heardTokensArr.includes('name') && heardTokensArr.includes('is')) return true;
      }
      return false;
    }

    if(checkEquivalence(expectedWords, heardTokens)){
      return { score: 100, errors: [], feedback: [], heard: heard };
    }

    expectedWords.forEach((w)=>{
      const exactPresent = heardTokens.includes(w);
      let fuzzyPresent = false;
      for(const hw of heardTokens){ if(similarity(w, hw) > 0.8){ fuzzyPresent = true; break; } }
      if(exactPresent || fuzzyPresent) return;

      // check pronunciation error patterns for this expected word
      if(pronunciationErrors[w]){
        const pattern = pronunciationErrors[w];
        const found = pattern.errors.find(err => heardTokens.includes(err) || heardTokens.some(h=> similarity(err,h) > 0.75));
        if(found){ errors.push({ word:w, mistake:found, feedback:pattern.feedback, spanish:pattern.spanish }); score -= 15; errorCounts[w] = (errorCounts[w]||0) + 1; return; }
      }

      const close = heardTokens.find(h=> similarity(w,h) > 0.6);
      if(close){ score -= 6; errors.push({word:w, mistake:close, feedback:'Close, but improve pronunciation.', spanish:'Cercano, mejora la pronunciaci√≥n.'}); }
      else { score -= 10; errors.push({word:w, mistake:null, feedback:'Missing or mispronounced word.', spanish:'Palabra ausente o mal pronunciada.'}); }
    });

    const overallSim = similarity(normExpected, normHeard);
    if(overallSim < 0.4) score = Math.min(score, 50);
    if(score < 0) score = 0; if(score > 100) score = 100;
    return { score: Math.round(score), errors, feedback:[], heard: heard };
  }

  for(const v of variants){
    const res = analyzeOne(v);
    if(res.score > bestResult.score) bestResult = res;
  }
  return bestResult;
}

// Enhanced evaluate: uses analyzePronunciation and displays rich feedback
function evaluate(text, confidence=null){
  const q = questions[idx]; if(!q) return; const heardText = text || '';
  const recEl = document.getElementById('recognized'); if(recEl) recEl.textContent = 'Recognized: ' + (heardText || '‚Äî');

  const analysis = analyzePronunciation(q.hint.replace(/\.\.\./g,'').replace(/\(.+\)/g,''), heardText, confidence);
  const score = analysis.score;
  // render stars and overall result
  let stars = 0; if(score>=90) stars = 3; else if(score>=70) stars = 2; else if(score>=50) stars = 1; else stars = 0;
  starsEl.textContent = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(3-stars);
  if(score>=90){ resultCard.className='result show good'; resultText.textContent = 'Excellent! ‚úÖ'; tipsEl.textContent = 'Great pronunciation. Keep it up!'; confetti(); }
  else if(score>=70){ resultCard.className='result show warn'; resultText.textContent = 'Good job! üëç'; tipsEl.textContent = 'Minor improvements suggested.'; }
  else if(score>=50){ resultCard.className='result show warn'; resultText.textContent = 'Needs practice üìù'; tipsEl.textContent = 'Focus on the highlighted sounds.'; }
  else { resultCard.className='result show bad'; resultText.textContent = 'Let\'s work on this üí™'; tipsEl.textContent = 'Try again and listen to the sample.'; }

  // populate issues list
  const issuesEl = document.getElementById('issuesList'); if(issuesEl) issuesEl.innerHTML = '';
  if(analysis.errors && analysis.errors.length){
    analysis.errors.forEach(it=>{
      const div = document.createElement('div'); div.style.marginBottom='8px';
      const title = document.createElement('div'); title.innerHTML = `‚ùå <strong>${it.mistake || '(missing)'}</strong> ‚Üí should be <strong>${it.word}</strong>`;
      const detail = document.createElement('div'); detail.className='small'; detail.textContent = it.feedback + ' ‚Äî ' + it.spanish;
      const play = document.createElement('button'); play.className='btn ghost'; play.style.marginTop='6px'; play.textContent='Play correction';
      play.onclick = ()=>{ speak(it.word,'en-US'); };
      div.appendChild(title); div.appendChild(detail); div.appendChild(play);
      if(issuesEl) issuesEl.appendChild(div);
    });
  }

  // progressive summary after 5 answers
  answeredCount++; const summaryEl = document.getElementById('progressSummary');
  if(answeredCount>0 && answeredCount%5===0){
    // find top errors
    const entries = Object.entries(errorCounts).sort((a,b)=>b[1]-a[1]);
    if(entries.length){
      const top = entries[0];
      if(summaryEl) summaryEl.textContent = `I noticed you often have trouble with '${top[0]}'. Let's practice that sound.`;
    }
  } else { if(summaryEl) summaryEl.textContent = ''; }
}

// Levenshtein distance for fuzzy matching
function levenshtein(a,b){ if(!a) return b?b.length:0; if(!b) return a.length; const m=a.length,n=b.length; const dp = Array.from({length:m+1},()=>new Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost = a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); }} return dp[m][n]; }

function similarity(a,b){ a=(a||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); b=(b||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); if(!a && !b) return 1; const dist = levenshtein(a,b); const maxLen = Math.max(a.length,b.length) || 1; return Math.max(0, 1 - dist/maxLen);
}

// Simple TTS helper to play the sample/model answer
function speak(text, lang='en-US'){
  if(!window.speechSynthesis){ timerEl.textContent = 'TTS not available in this browser.'; return; }
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang; u.rate = 0.95; u.pitch = 1;
    speechSynthesis.speak(u);
  } catch(err){ console.error('TTS error', err); timerEl.textContent = 'Error playing sample: ' + (err.message||err.name); }
}

// Play sample button logic
if(playSampleBtn){
  playSampleBtn.addEventListener('click', ()=>{
    const q = questions[idx];
    if(!q){ timerEl.textContent = 'Choose a question first (Next).'; return; }
    const example = sampleForQuestion(idx) || q.hint.replace('...', 'an example');
    const sample = q.q + ' Example: ' + example;
    speak(sample,'en-US');
  });
}

// Ensure microphone access and devices before starting recognition
async function ensureMicAccess(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    timerEl.textContent = 'Microphone API not supported. Use a modern browser (Chrome/Edge).';
    return false;
  }
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const hasInput = devices.some(d=>d.kind === 'audioinput');
    if(!hasInput){ timerEl.textContent = 'No microphone found. Connect a microphone and try again.'; return false; }
    // If we already have a stream, keep it. Otherwise request one to prompt permissions.
    if(!window._localMicStream){
      const s = await navigator.mediaDevices.getUserMedia({ audio:true });
      window._localMicStream = s;
    }
    timerEl.textContent = 'Microphone ready';
    return true;
  } catch(err){
    console.error('getUserMedia error', err);
    timerEl.textContent = 'Microphone permission denied or error: ' + (err.message || err.name);
    return false;
  }
}

startBtn.addEventListener('click', async ()=>{
  if(!recognition){ timerEl.textContent = 'SpeechRecognition not supported in this browser.'; return; }
  startBtn.disabled = true;
  // Check mic and request permissions if needed
  const ok = await ensureMicAccess();
  if(!ok){ startBtn.disabled = false; return; }
  try{
    recognition.start();
    startBtn.disabled=true; stopBtn.disabled=false; micBtn.classList.add('mic-pulse'); startTimer(); timerEl.textContent = 'Recording...';
  } catch(e){ console.error(e); timerEl.textContent = 'Error starting recording: ' + (e.message || e.name); startBtn.disabled=false; stopBtn.disabled=true; }
});

stopBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  try{ recognition.stop(); } catch(e){ console.warn(e); }
  // stop local stream tracks if we have them
  if(window._localMicStream){ try{ window._localMicStream.getTracks().forEach(t=>t.stop()); }catch(e){} window._localMicStream = null; }
  startBtn.disabled=false; stopBtn.disabled=true; micBtn.classList.remove('mic-pulse'); stopTimer();
});

micBtn.addEventListener('click', ()=>{
  // Toggle recording: start if stopped, stop if recording
  const isRecording = !stopBtn.disabled;
  if(!isRecording){ startBtn.click(); micBtn.setAttribute('aria-pressed','true'); }
  else { stopBtn.click(); micBtn.setAttribute('aria-pressed','false'); }
});
micBtn.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); micBtn.click(); } });
micBtn.addEventListener('touchstart', ()=> micBtn.classList.add('mic-pulse'));

if(recognition){
  recognition.onstart = ()=>{ timerEl.textContent = 'Recording...'; const live = document.getElementById('liveTranscript'); if(live) live.textContent = ''; micBtn.setAttribute('aria-pressed','true'); };
  recognition.onresult = (ev)=>{
    let interim = '';
    let final = '';
    let confSum = 0, confCount = 0;
    for(let i=0;i<ev.results.length;i++){
      const r = ev.results[i];
      const t = (r[0] && r[0].transcript) ? r[0].transcript : '';
      if(r[0] && typeof r[0].confidence === 'number'){ confSum += r[0].confidence; confCount++; }
      if(r.isFinal) final += t + ' ';
      else interim += t + ' ';
    }
    const live = document.getElementById('liveTranscript');
    if(live) live.textContent = (final + interim).trim() || '';
    if(final.trim()){
      const avgConf = confCount? (confSum/confCount) : null;
      evaluate(final.trim(), avgConf);
    }
  }
  recognition.onend = ()=>{
    startBtn.disabled=false; stopBtn.disabled=true; micBtn.classList.remove('mic-pulse'); micBtn.setAttribute('aria-pressed','false'); stopTimer();
    if(window._localMicStream){ try{ window._localMicStream.getTracks().forEach(t=>t.stop()); }catch(e){} window._localMicStream = null; }
    timerEl.textContent = 'Processing...'; setTimeout(()=> timerEl.textContent='00:00',800);
  }
  recognition.onerror = (e)=>{ console.error(e); startBtn.disabled=false; stopBtn.disabled=true; micBtn.classList.remove('mic-pulse'); stopTimer();
    if(window._localMicStream){ try{ window._localMicStream.getTracks().forEach(t=>t.stop()); }catch(err){} window._localMicStream = null; }
    timerEl.textContent = 'Microphone error: ' + (e.error||e.message||'unknown');
  }
}

nextBtn.addEventListener('click', ()=>{ if(idx < total-1) idx++; else idx = 0; showQuestion(idx); });
nextMainBtn.addEventListener('click', ()=>{ if(idx < total-1) idx++; else idx = 0; showQuestion(idx); });
tryBtn.addEventListener('click', ()=>{ resultCard.classList.remove('show'); const live = document.getElementById('liveTranscript'); if(live) live.textContent = ''; startBtn.click(); });

// init
showQuestion(-1);
  </script>
</body>
</html>